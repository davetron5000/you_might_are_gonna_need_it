<!DOCTYPE html>
<html>
  <head>
    <title>You might "Are Gonna Need It" - Avoiding the MonoRail</title>
    <script src="js/lib/jquery-1.8.0.min.js"></script>
    <script src="js/lib/highlight-7.1.min.js"></script>
    <script src="js/lib/jquerytypewriter.js"></script>
    <script src="js/lib/underscore-1.3.3.min.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/sizer.js"></script>
    <script src="js/bullets.js"></script>
    <script src="js/trickster.js"></script>
    <script src="js/custom.js"></script>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/styles.css">
    <script>
      $(window).load(function() {
        Trickster = TricksterLoader(TricksterDefaultConfig,{});
        Trickster.load();
      });
    </script>
  </head>
  <body><div id="contents">
    <section class='TITLE'>
<h1>You might "Are Gonna Need It"</h1>
<h2>Avoiding the MonoRail</h2>
<h3>@davetron5000</h3>
</section>
<section class='SECTION'>
<h1>Me</h1>
</section>
<section class='SECTION'>
<h1>@davetron5000</h1>
</section>
<section class='BULLETS'>
<h1>Lead Engineer @ Stitch Fix</h1>
<ul>
<li>One horrible Django App</li>
<li>Special-purpose Rails Apps</li>
<li>Gems & Services</li>
</ul>
</section>
<section class='BULLETS'>
<h1>Former Engineer @ LivingSocial</h1>
<ul>
<li>One giant monorail</li>
<li>Array of payment-related services</li>
</ul>
</section>
<section class='IMAGE'>
<img src='images/book.png'>
</section>
<section class='SECTION'>
<h1>What's a MonoRail?</h1>
<h2><img src="images/monorail.jpg"></h2>
</section>
<section class='BULLETS'>
<h1>A MonoRail</h1>
<ul>
<li>Rails app</li>
<li>Monolithic</li>
<li>Too big, too hard to change over time</li>
</ul>
</section>
<section class='IMAGE'>
<img src='images/monorail_busted.png'>
</section>
<section class='BULLETS'>
<h1>Reality Check</h1>
<ul>
<li>Not building a blog</li>
<li>Not building basecamp</li>
<li>Not building web-based `rails c`</li>
<li>You will (eventually) stray from the Golden Path</li>
</ul>
</section>
<section class='IMAGE'>
<img src='images/god_emperor.jpg'>
</section>
<section class='BULLETS'>
<h1>The Golden Path</h1>
<ul>
<li>All logic in models</li>
<li>One database</li>
<li>Rails Mailers</li>
<li>In-request processing</li>
</ul>
</section>
<section class='IMAGE'>
<img src='images/graph.png'>
</section>
<section class='SECTION'>
<h1>When the time comes</h1>
<h2>how can we be prepared?</h2>
</section>
<section class='SECTION'>
<h1>But, but</h1>
<h2>YAGNI!</h2>
</section>
<section class='QUOTE'>
<h1><a href="http://c2.com/cgi/wiki?YouArentGonnaNeedIt">YAGNI</a></h1>
<h2><blockquote>Always implement things when you actually need them, never when you just foresee that you need them.</blockquote></h2>
</section>
<section class='SECTION'>
<h1>i.e.</h1>
<h2>Don't waste time building things you don't know you'll need</h2>
</section>
<section class='SECTION'>
<h1>Code <strong>will</strong> change</h1>
</section>
<section class='SECTION'>
<h1>Can we make those changes easier</h1>
<h2>without wasting time/effort now?</h2>
</section>
<section class='SECTION'>
<h1>Yes we can (use obama-style image)</h1>
</section>
<section class='SECTION'>
<h1>Changes we want to be easy</h1>
</section>
<section class='SECTION'>
<h1>Changes we want to be easy</h1>
<h2>Splitting up the database</h2>
</section>
<section class='SECTION'>
<h1>Changes we want to be easy</h1>
<h2>Other apps accessing our database</h2>
</section>
<section class='SECTION'>
<h1>Changes we want to be easy</h1>
<h2>Do work in the background</h2>
</section>
<section class='SECTION'>
<h1>Changes we want to be easy</h1>
<h2>Share business logic</h2>
</section>
<section class='BULLETS'>
<h1>Why worry now?</h1>
<ul>
<li>Chance of you "not needing it" ~ 0</li>
<li>When you do, it will be later than you "should" deal with it</li>
</ul>
</section>
<section class='BULLETS'>
<h1>Avoiding the MonoRail</h1>
<ul>
<li>Make deployment easy</li>
<li>Better-factored code</li>
<li>Use your database</li>
<li></li>
</ul>
</section>
<section class='SECTION'>
<h1>Step 1 - Deployment</h1>
</section>
<section class='SECTION'>
<h1>"Let's just keep it in www because it's too much of a pain to make a new app"</h1>
</section>
<section class='IMAGE'>
<img src='Picard facepalm'>
</section>
<section class='BULLETS'>
<h1>Frictionless deployments</h1>
<ul>
<li>One step deploy</li>
<li>New apps self-service (or VERY low friction)</li>
<li>Learn you some scripting</li>
<li>App generators</li>
</ul>
</section>
<section class='BULLETS'>
<h1>App Generators</h1>
<ul>
<li>Use existing app as a template</li>
<li>exception notifications, performance monitoring, logging, authentication, etc.</li>
</ul>
</section>
<section class='SECTION'>
<h1>Step 2 - Light Indirection</h1>
</section>
<section class='SECTION'>
<h1>Business Logic</h1>
<h2>It's not to go in your models</h2>
<h3>(nor your controllers)</h3>
</section>
<section class='BULLETS'>
<h1>Where?!?!?!?!?</h1>
<ul>
<li>You don't need DCI</li>
<li>You don't need a DSL</li>
<li>You don't need a framework</li>
</ul>
</section>
<section class='SECTION'>
<h1>Make a class</h1>
</section>
<section class='CODE'>
<pre><code class='ruby' data-strikeouts='' data-callout-lines=''><span class='line line-1 ' >def create</span>
<span class='line line-2 ' >  customer = current_user</span>
<span class='line line-3 ' >  purchase = Purchase.new(params, customer: customer)</span>
<span class='line line-4 ' >  if purchase.type == 'electronic'</span>
<span class='line line-5 ' >    if purchase.assets_available? &&</span>
<span class='line line-6 ' >       purchase.charge</span>
<span class='line line-7 ' >       redirect_to purchase.asset_url</span>
<span class='line line-8 ' >    else</span>
<span class='line line-9 ' >      queue_purchase_for_later(puchase)</span>
<span class='line line-10 ' >    end</span>
<span class='line line-11 ' >  else</span>
<span class='line line-12 ' >    purchase.charge!</span>
<span class='line line-13 ' >  end</span>
<span class='line line-14 ' >end</span></code></pre>
</section>
<section class='CODE'>
<pre><code class='ruby' data-strikeouts='' data-callout-lines='3,4,5,6,8,10,11'><span class='line line-1 ' >def create</span>
<span class='line line-2 ' >  customer = current_user</span>
<div class='lines-callout'><span class='line line-3 line-callout' >  purchase = Purchase.new(params, customer: customer)</span>
<span class='line line-4 line-callout' >  if purchase.type == 'electronic'</span>
<span class='line line-5 line-callout' >    if purchase.assets_available? &&</span>
<span class='line line-6 line-callout' >       purchase.charge</span>
</div><span class='line line-7 ' >       redirect_to purchase.asset_url</span>
<div class='lines-callout'><span class='line line-8 line-callout' >    else</span>
</div><span class='line line-9 ' >      queue_purchase_for_later(puchase)</span>
<div class='lines-callout'><span class='line line-10 line-callout' >    end</span>
<span class='line line-11 line-callout' >  else</span>
</div><span class='line line-12 ' >    purchase.charge!</span>
<span class='line line-13 ' >  end</span>
<span class='line line-14 ' >end</span></code></pre>
</section>
<section class='CODE'>
<pre><code class='ruby' data-strikeouts='' data-callout-lines=''><span class='line line-1 ' >def create</span>
<span class='line line-2 ' >  customer = current_user</span>
<span class='line line-3 ' >  result = PurchaseService.purchase!(customer,params)</span>
<span class='line line-4 ' >  unless result.success?</span>
<span class='line line-5 ' >    @purchase = result.purchase</span>
<span class='line line-6 ' >    render "edit"</span>
<span class='line line-7 ' >  end</span>
<span class='line line-8 ' >end</span></code></pre>
</section>
<section class='CODE'>
<pre><code class='ruby' data-strikeouts='' data-callout-lines=''><span class='line line-1 ' >class PurchaseService # this name sucks</span>
<span class='line line-2 ' >  def self.purchase!(customer,params)</span>
<span class='line line-3 ' >    purchase = Purchase.new(params, customer: customer)</span>
<span class='line line-4 ' >    return Results.unsuccessful(purchase) unless purchase.valid?</span>
<span class='line line-5 ' >    if purchase.type == 'electronic'</span>
<span class='line line-6 ' >      if purchase.assets_available? &&</span>
<span class='line line-7 ' >         purchase.charge</span>
<span class='line line-8 ' >      else</span>
<span class='line line-9 ' >        queue_purchase_for_later(puchase)</span>
<span class='line line-10 ' >      end</span>
<span class='line line-11 ' >    else</span>
<span class='line line-12 ' >      purchase.charge!</span>
<span class='line line-13 ' >    end</span>
<span class='line line-14 ' >    Result.successful(purchase)</span>
<span class='line line-15 ' >  end</span>
<span class='line line-16 ' >end</span></code></pre>
</section>
<section class='BULLETS'>
<h1>Why?</h1>
<ul>
<li>Same amount of code</li>
<li>Cleaner, better factored</li>
<li><tt>PurchaseService</tt>'s implementation can be replaced</li>
</ul>
</section>
<section class='CODE'>
<pre><code class='ruby' data-strikeouts='' data-callout-lines=''><span class='line line-1 ' >def show</span>
<span class='line line-2 ' >  @purchases = Person.find(params[:id]).</span>
<span class='line line-3 ' >    purchases.</span>
<span class='line line-4 ' >    successful.</span>
<span class='line line-5 ' >    shipped.</span>
<span class='line line-6 ' >    received_since(4.days.ago)</span>
<span class='line line-7 ' >  end</span>
<span class='line line-8 ' >end</span></code></pre>
</section>
<section class='CODE'>
<pre><code class='ruby' data-strikeouts='' data-callout-lines=''><span class='line line-1 ' >def show</span>
<span class='line line-2 ' >  @purchases = PurchaseSearchService.recently_received(</span>
<span class='line line-3 ' >      Person.find(params[:id]))</span>
<span class='line line-4 ' >  end</span>
<span class='line line-5 ' >end</span>
<span class='line line-6 ' ></span>
<span class='line line-7 ' >class PurchaseSearchService</span>
<span class='line line-8 ' >  def self.recently_received(person)</span>
<span class='line line-9 ' >    person.purchases.</span>
<span class='line line-10 ' >      successful.</span>
<span class='line line-11 ' >      shipped.</span>
<span class='line line-12 ' >      received_since(4.days.ago)</span>
<span class='line line-13 ' >  end</span>
<span class='line line-14 ' >end</span></code></pre>
</section>
<section class='BULLETS'>
<h1>Better</h1>
<ul>
<li>Controller is clearer</li>
<li><tt>PurchaseSearchService</tt> interface can be replaced</li>
<li>Same code</li>
<li>Probably easier to test</li>
</ul>
</section>
<section class='CODE'>
<pre><code class='ruby' data-strikeouts='' data-callout-lines=''><span class='line line-1 ' >class PurchasePresenter</span>
<span class='line line-2 ' >  def initialize(purchase)</span>
<span class='line line-3 ' >    @purchase = purchase</span>
<span class='line line-4 ' >    @customer = purchase.customer</span>
<span class='line line-5 ' >  end</span>
<span class='line line-6 ' ></span>
<span class='line line-7 ' >  def customer_name</span>
<span class='line line-8 ' >    @customer.name</span>
<span class='line line-9 ' >  end</span>
<span class='line line-10 ' ></span>
<span class='line line-11 ' >  def purchase_price</span>
<span class='line line-12 ' >    @purchase.price || 0</span>
<span class='line line-13 ' >  end</span>
<span class='line line-14 ' ></span>
<span class='line line-15 ' >  # etc.</span>
<span class='line line-16 ' >end</span></code></pre>
</section>
<section class='CODE'>
<pre><code class='ruby' data-strikeouts='' data-callout-lines=''><span class='line line-1 ' >class PurchasePresenter</span>
<span class='line line-2 ' >  attr_reader :customer_name,</span>
<span class='line line-3 ' >              :purchase_price</span>
<span class='line line-4 ' ></span>
<span class='line line-5 ' >  def initialize(attribtues)</span>
<span class='line line-6 ' >    @customer_name = attributes[:customer_name]</span>
<span class='line line-7 ' >    @purchase_price = attributes[:purchase_price]</span>
<span class='line line-8 ' >    # etc., or use some reflection</span>
<span class='line line-9 ' >  end</span>
<span class='line line-10 ' ></span>
<span class='line line-11 ' >  def self.from_purchase(purchase)</span>
<span class='line line-12 ' >    self.new(customer_name: purchase.customer.name,</span>
<span class='line line-13 ' >            purchase_price: purchase_price.price || 0)</span>
<span class='line line-14 ' >  end</span>
<span class='line line-15 ' >end</span></code></pre>
</section>
<section class='BULLETS'>
<h1>Better</h1>
<ul>
<li><tt>PurchasePresenter</tt>'s <em>interface</em> is decoupled from where the values come from - it's just a dumb struct</li>
<li>It can be replaced</li>
<li>It can be constructed another way, e.g. a series of API calls</li>
<li>Same effort to implement</li>
</ul>
</section>
<section class='CODE'>
<pre><code class='ruby' data-strikeouts='' data-callout-lines=''><span class='line line-1 ' >class MySnazzyService</span>
<span class='line line-2 ' >  def doit_now_i_am_here(predator)</span>
<span class='line line-3 ' >    result = bunch_of_complex_logic(predator)</span>
<span class='line line-4 ' >    CIAMailer.team_lost(result)</span>
<span class='line line-5 ' >  end</span>
<span class='line line-6 ' >end</span></code></pre>
</section>
<section class='CODE'>
<pre><code class='ruby' data-strikeouts='' data-callout-lines=''><span class='line line-1 ' >class MySnazzyService</span>
<span class='line line-2 ' >  def doit_now_i_am_here(predator)</span>
<span class='line line-3 ' >    result = bunch_of_complex_logic(predator)</span>
<span class='line line-4 ' >    CIAMailer.team_lost(result).deliver # OOPS</span>
<span class='line line-5 ' >  end</span>
<span class='line line-6 ' >end</span></code></pre>
</section>
<section class='CODE'>
<pre><code class='ruby' data-strikeouts='' data-callout-lines=''><span class='line line-1 ' >class MySnazzyService</span>
<span class='line line-2 ' >  def doit_now_i_am_here(predator)</span>
<span class='line line-3 ' >    result = bunch_of_complex_logic(predator)</span>
<span class='line line-4 ' >    Email.send(:team_lost,result)</span>
<span class='line line-5 ' >  end</span>
<span class='line line-6 ' >end</span>
<span class='line line-7 ' ></span>
<span class='line line-8 ' >class Email</span>
<span class='line line-9 ' >  def self.send(email,*args)</span>
<span class='line line-10 ' >    CIAMailer.send(email,args)</span>
<span class='line line-11 ' >  end</span>
<span class='line line-12 ' >end</span></code></pre>
</section>
<section class='BULLETS'>
<h1>Better</h1>
<ul>
<li><tt>Email</tt> can...</li>
<li>...<strong>Be replaced!</strong></li>
</ul>
</section>
<section class='CODE'>
<pre><code class='ruby' data-strikeouts='' data-callout-lines=''><span class='line line-1 ' >class Email</span>
<span class='line line-2 ' >  def self.send(email,*args)</span>
<span class='line line-3 ' >    CIAMailer.send(email,args)</span>
<span class='line line-4 ' >  end</span>
<span class='line line-5 ' >end</span></code></pre>
</section>
<section class='CODE'>
<pre><code class='ruby' data-strikeouts='' data-callout-lines=''><span class='line line-1 ' >class Email</span>
<span class='line line-2 ' >  def self.send(email,*args)</span>
<span class='line line-3 ' >    queue(:email, ->() {</span>
<span class='line line-4 ' >      CIAMailer.send(email,args)</span>
<span class='line line-5 ' >    }</span>
<span class='line line-6 ' >  end</span>
<span class='line line-7 ' >end</span></code></pre>
</section>
<section class='SECTION'>
<h1>Sensing a theme?</h1>
</section>
<section class='SECTION'>
<h1>Step 3 - Use Your Database</h1>
</section>
<section class='CODE'>
<pre><code class='ruby' data-strikeouts='' data-callout-lines=''><span class='line line-1 ' >def up</span>
<span class='line line-2 ' >  create_table :things do |t|</span>
<span class='line line-3 ' >    t.belongs_to :customer</span>
<span class='line line-4 ' >    t.string     :name</span>
<span class='line line-5 ' >    t.integer    :thing_type</span>
<span class='line line-6 ' >    t.timestamps</span>
<span class='line line-7 ' >  end</span>
<span class='line line-8 ' >end</span></code></pre>
</section>
<section class='BULLETS'>
<h1>Who needs data integrity?</h1>
<ul>
<li>nullable by default</li>
<li>no foreign keys</li>
<li>no indexes</li>
</ul>
</section>
<section class='CODE'>
<pre><code class='ruby' data-strikeouts='' data-callout-lines=''><span class='line line-1 ' >def up</span>
<span class='line line-2 ' >  create_table :things do |t|</span>
<span class='line line-3 ' >    t.belongs_to :customer,   null: false</span>
<span class='line line-4 ' >    t.string     :name,       null: true</span>
<span class='line line-5 ' >    t.integer    :thing_type, null: false</span>
<span class='line line-6 ' >    t.timestamps</span>
<span class='line line-7 ' >  end</span>
<span class='line line-8 ' >  add_index :things, [:thing_type]</span>
<span class='line line-9 ' >  execute "ALTER table things </span>
<span class='line line-10 ' >           ADD FOREIGN KEY </span>
<span class='line line-11 ' >           (customer_id) REFERENCES customer(id);"</span>
<span class='line line-12 ' >end</span></code></pre>
</section>
<section class='BULLETS'>
<h1>Better</h1>
<ul>
<li><tt>null: true</tt> shows intent, not forgetfulness</li>
<li>index what you'll query on</li>
<li>foreign keys keep data safe from prying shell scripts</li>
</ul>
</section>

  </div></body>
</html>
